<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FormFit AI - Voice Coach</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js" crossorigin="anonymous"></script>
    <style>
/* ============================================================
   FORMFIT AI - STYLES
   ============================================================ */

:root {
    --bg-dark: #0a0a0b;
    --bg-card: #141418;
    --accent-primary: #00ff87;
    --accent-secondary: #00d4ff;
    --accent-error: #ff3860;
    --accent-purple: #a855f7;
    --text-primary: #ffffff;
    --text-secondary: #8a8a9a;
    --border-subtle: #2a2a35;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg-dark);
    color: var(--text-primary);
    min-height: 100vh;
}

.app {
    min-height: 100vh;
}

/* ============================================================
   HEADER
   ============================================================ */

.header {
    padding: 16px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-subtle);
    background: rgba(10, 10, 11, 0.95);
    position: sticky;
    top: 0;
    z-index: 100;
}

.logo {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 24px;
    font-weight: 800;
}

.logo span {
    background: linear-gradient(135deg, #00ff87, #00d4ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-right {
    display: flex;
    align-items: center;
    gap: 20px;
}

.stat {
    text-align: center;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent-primary);
}

.stat-label {
    font-size: 11px;
    color: var(--text-secondary);
    text-transform: uppercase;
}

/* ============================================================
   MAIN CONTENT
   ============================================================ */

.main {
    padding: 32px;
    width: 100%;
    margin: 0 auto;
}

/* ============================================================
   VOICE BANNER
   ============================================================ */

.voice-banner {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(99, 102, 241, 0.15));
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 16px;
    padding: 16px 24px;
    margin-bottom: 32px;
    display: flex;
    align-items: center;
    gap: 16px;
}

.voice-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #a855f7, #6366f1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    transition: box-shadow 0.3s;
}

.voice-avatar.speaking {
    box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
}

.voice-info {
    flex: 1;
}

.voice-title {
    font-size: 16px;
    font-weight: 700;
}

.voice-status {
    font-size: 13px;
    color: var(--text-secondary);
}

/* ============================================================
   BUTTONS
   ============================================================ */

.btn {
    padding: 10px 20px;
    border-radius: 10px;
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}

.btn-purple {
    background: linear-gradient(135deg, #a855f7, #6366f1);
    color: white;
}

.btn-purple:hover {
    box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
}

.btn-primary {
    background: linear-gradient(135deg, #00ff87, #00d4ff);
    color: #0a0a0b;
}

.btn-primary:hover {
    box-shadow: 0 0 20px rgba(0, 255, 135, 0.4);
}

.btn-secondary {
    background: transparent;
    border: 1px solid var(--border-subtle);
    color: var(--text-primary);
}

.btn-secondary:hover {
    border-color: var(--accent-primary);
}

.btn-danger {
    background: rgba(255, 56, 96, 0.2);
    color: var(--accent-error);
}

.btn-danger:hover {
    background: var(--accent-error);
    color: white;
}

.btn-full {
    width: 100%;
}

/* ============================================================
   PAGE TITLE
   ============================================================ */

.page-title {
    text-align: center;
    margin-bottom: 32px;
}

.page-title h1 {
    font-size: 36px;
    font-weight: 800;
    margin-bottom: 8px;
}

.page-title p {
    color: var(--text-secondary);
}

/* ============================================================
   CATEGORY TABS
   ============================================================ */

.tabs {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 32px;
    flex-wrap: wrap;
}

.tab {
    padding: 10px 20px;
    border-radius: 100px;
    border: 1px solid var(--border-subtle);
    background: transparent;
    color: var(--text-secondary);
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.tab:hover {
    border-color: var(--accent-primary);
    color: white;
}

.tab.active {
    background: linear-gradient(135deg, #00ff87, #00d4ff);
    border-color: transparent;
    color: #0a0a0b;
    font-weight: 600;
}

/* ============================================================
   EXERCISE GRID & CARDS
   ============================================================ */

.grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 20px;
}

.card {
    background: var(--bg-card);
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid var(--border-subtle);
    cursor: pointer;
    transition: transform 0.2s, border-color 0.2s;
}

.card:hover {
    transform: translateY(-4px);
    border-color: var(--accent-primary);
}

.card-img {
    aspect-ratio: 1 / 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

.card-img img{
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.card-body {
    padding: 16px;
}

.card-category {
    font-size: 11px;
    color: var(--accent-primary);
    text-transform: uppercase;
    font-weight: 600;
    margin-bottom: 4px;
}

.card-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
}

.card-desc {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.4;
}

.card-muscles {
    display: flex;
    gap: 6px;
    margin-top: 12px;
    flex-wrap: wrap;
}

.muscle-tag {
    padding: 4px 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    font-size: 11px;
    color: var(--text-secondary);
}

/* ============================================================
   ANALYSIS VIEW
   ============================================================ */

.analysis {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 24px;
}

@media (max-width: 1000px) {
    .analysis {
        grid-template-columns: 1fr;
    }
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    margin-bottom: 20px;
    transition: color 0.2s;
}

.back-btn:hover {
    color: var(--accent-primary);
}

/* ============================================================
   VIDEO BOX
   ============================================================ */

.video-box {
    background: var(--bg-card);
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    aspect-ratio: 16/10;
}

.video-box video,
.video-box canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.video-box canvas {
    z-index: 2;
}

/* ============================================================
   VIDEO OVERLAY
   ============================================================ */

.overlay {
    position: absolute;
    inset: 0;
    z-index: 3;
    pointer-events: none;
}

.stat-box {
    position: absolute;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(8px);
    padding: 12px 16px;
    border-radius: 12px;
}

.accuracy-box {
    top: 16px;
    left: 16px;
}

.phase-box {
    top: 16px;
    right: 16px;
    text-align: center;
}

.rep-box {
    bottom: 16px;
    left: 16px;
    background: linear-gradient(135deg, #00ff87, #00d4ff);
    text-align: center;
}

.stat-box .label {
    font-size: 10px;
    text-transform: uppercase;
    opacity: 0.7;
}

.stat-box .value {
    font-size: 32px;
    font-weight: 700;
    line-height: 1;
}

.rep-box .label,
.rep-box .value {
    color: #0a0a0b;
}

.accuracy-box .value.good {
    color: var(--accent-primary);
}

.accuracy-box .value.ok {
    color: var(--accent-secondary);
}

.accuracy-box .value.bad {
    color: var(--accent-error);
}

.phase-box .value {
    color: var(--accent-secondary);
    font-size: 18px;
}

.phase-box .value.idle {
    color: var(--text-secondary);
}

.fps-counter {
    position: absolute;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.6);
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 11px;
    color: var(--text-secondary);
}

/* ============================================================
   COACH BOX
   ============================================================ */

.coach-box {
    position: absolute;
    bottom: 16px;
    right: 16px;
    background: rgba(0, 0, 0, 0.8);
    border: 1px solid rgba(168, 85, 247, 0.4);
    padding: 12px 16px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 260px;
    transition: border-color 0.3s, box-shadow 0.3s;
}

.coach-box.speaking {
    border-color: var(--accent-purple);
    box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
}

.coach-avatar-sm {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #a855f7, #6366f1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.coach-msg {
    font-size: 13px;
    line-height: 1.3;
}

/* ============================================================
   SIDE PANEL
   ============================================================ */

.panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.panel-card {
    background: var(--bg-card);
    border-radius: 16px;
    padding: 16px;
    border: 1px solid var(--border-subtle);
}

.panel-title {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 12px;
}

.preview-img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 12px;
}

.preview-name {
    font-size: 20px;
    font-weight: 700;
    text-align: center;
}

.preview-cat {
    color: var(--accent-primary);
    font-size: 13px;
    text-align: center;
}

/* ============================================================
   FEEDBACK PANEL
   ============================================================ */

.feedback-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 10px;
    margin-bottom: 8px;
    font-size: 13px;
}

.feedback-item:last-child {
    margin-bottom: 0;
}

.feedback-item.good {
    background: rgba(0, 255, 135, 0.1);
    border-left: 3px solid var(--accent-primary);
}

.feedback-item.bad {
    background: rgba(255, 56, 96, 0.1);
    border-left: 3px solid var(--accent-error);
}

.feedback-item.warning {
    background: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
    color: #ffc107;
}

.feedback-icon {
    font-weight: 700;
}

/* ============================================================
   VOICE SETTINGS
   ============================================================ */

.toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
}

.toggle {
    width: 44px;
    height: 24px;
    background: var(--border-subtle);
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
}

.toggle.on {
    background: var(--accent-primary);
}

.toggle::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    background: white;
    border-radius: 50%;
    top: 3px;
    left: 3px;
    transition: transform 0.2s;
}

.toggle.on::after {
    transform: translateX(20px);
}

/* ============================================================
   INSTRUCTIONS
   ============================================================ */

.instruction {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    font-size: 13px;
}

.instruction:last-child {
    margin-bottom: 0;
}

.instruction-num {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(0, 255, 135, 0.1);
    color: var(--accent-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    flex-shrink: 0;
}

.instruction-text {
    color: var(--text-secondary);
    padding-top: 2px;
}

/* ============================================================
   LOADING
   ============================================================ */

.loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 300px;
    text-align: center;
}

.loading-icon {
    width: 60px;
    height: 60px;
    border: 3px solid var(--border-subtle);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* ============================================================
   RESPONSIVE
   ============================================================ */

@media (max-width: 768px) {
    .header {
        padding: 12px 16px;
    }

    .main {
        padding: 16px;
    }

    .voice-banner {
        flex-direction: column;
        text-align: center;
        gap: 12px;
    }

    .page-title h1 {
        font-size: 28px;
    }

    .grid {
        grid-template-columns: 1fr;
    }
}
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // ==================== VOICE COACH ====================
        class VoiceCoach {
            constructor() {
                this.synth = window.speechSynthesis;
                this.enabled = true; 
                this.lastSpoke = 0; 
                this.minGap = 3000; // Reduced from 6000
                this.speaking = false; 
                this.message = ""; 
                this.onChange = null;
                this.hasPromptedToStart = false; // Track if we've already prompted
                const setVoice = () => { this.voice = this.synth.getVoices().find(v => v.lang.includes('en')) || this.synth.getVoices()[0]; };
                if (this.synth.getVoices().length) setVoice(); else this.synth.onvoiceschanged = setVoice;
            }
            speak(msg, force = false) {
                if (!this.enabled || !msg) return;
                const now = Date.now();
                if (!force && now - this.lastSpoke < this.minGap) {
                    console.log('Voice blocked by timing:', now - this.lastSpoke, 'ms since last');
                    return;
                }
                
                console.log('Speaking:', msg);
                this.synth.cancel();
                const u = new SpeechSynthesisUtterance(msg); 
                u.voice = this.voice; 
                u.rate = 1.1;
                u.onstart = () => { this.speaking = true; this.message = msg; this.onChange?.(true, msg); };
                u.onend = () => { this.speaking = false; this.lastSpoke = Date.now(); this.onChange?.(false, ""); };
                this.synth.speak(u);
            }
            getFeedback(acc, fb, isMoving, isInPosition) {
                // Not moving - prompt to start (but only once)
                if (!isMoving) {
                    if (!this.hasPromptedToStart) {
                        this.hasPromptedToStart = true;
                        return "Start moving! Begin the exercise.";
                    }
                    return null; // Don't keep nagging
                }
                
                // Reset the prompt flag once they start moving
                if (isMoving && this.hasPromptedToStart) {
                    this.hasPromptedToStart = false;
                }
                
                // Not in proper position
                if (!isInPosition) {
                    return "Get into position first.";
                }
                
                // Check for specific form errors FIRST (prioritize corrections)
                if (fb?.length > 0) {
                    const f = fb[0].toLowerCase();
                    
                    // Shoulder press specific (from combined.py)
                    if (f.includes('keep arms moving evenly')) return "Keep your arms moving evenly!";
                    if (f.includes('stack wrists over elbows')) return "Stack your wrists over your elbows!";
                    
                    // Elbow corrections
                    if (f.includes('left elbow') && f.includes('extend')) return "Extend your left arm more!";
                    if (f.includes('right elbow') && f.includes('extend')) return "Extend your right arm more!";
                    if (f.includes('elbow') && f.includes('extend')) return "Straighten your arms more!";
                    if (f.includes('left elbow') && f.includes('bend')) return "Bend your left elbow more!";
                    if (f.includes('right elbow') && f.includes('bend')) return "Bend your right elbow more!";
                    if (f.includes('elbow') && f.includes('bend')) return "Bend your elbows deeper!";
                    
                    // Knee corrections
                    if (f.includes('left knee') && f.includes('bend')) return "Lower down more on left leg!";
                    if (f.includes('right knee') && f.includes('bend')) return "Lower down more on right leg!";
                    if (f.includes('knee') && f.includes('bend')) return "Squat lower!";
                    if (f.includes('left knee') && f.includes('extend')) return "Stand up straighter on left leg!";
                    if (f.includes('right knee') && f.includes('extend')) return "Stand up straighter on right leg!";
                    if (f.includes('knee') && f.includes('extend')) return "Stand up fully!";
                    
                    // Arm raise corrections
                    if (f.includes('arm raise') && f.includes('extend')) return "Raise your arms higher!";
                    if (f.includes('arm raise') && f.includes('bend')) return "Lower your arms more!";
                    
                    // Generic form check
                    return "Watch your form!";
                }
                
                // Good form while moving (only if no errors)
                if (acc >= 95) return ["Perfect!", "Great form!", "Excellent!"][Math.floor(Math.random() * 3)];
                if (acc >= 75) return "Good! Keep going!";
                if (acc >= 60) return "Not bad, focus on form!";
                
                return "Keep going!";
            }
            announceRep(n) { 
                if (!this.enabled) return; 
                if (n === 1) this.speak("One!", true);
                else if (n === 5) this.speak("Five! Great job!", true);
                else if (n === 10) this.speak("Ten! You're on fire!", true);
                else if (n % 5 === 0) this.speak(`${n}!`, true);
                else this.speak(`${n}`, true);
            }
            start(name) { 
                this.hasPromptedToStart = false; // Reset flag for new exercise
                this.speak(`Starting ${name}. Get into position and begin!`, true); 
            }
            end(name, reps) { this.speak(`Done! ${reps} reps of ${name}. Great workout!`, true); }
            stop() { this.synth.cancel(); this.speaking = false; }
            setEnabled(v) { this.enabled = v; if (!v) this.stop(); }
        }
        const voiceCoach = new VoiceCoach();

        // ==================== POSE UTILS ====================
        const calcAngle = (a, b, c) => {
            const v1x = a.x - b.x, v1y = a.y - b.y, v2x = c.x - b.x, v2y = c.y - b.y;
            return Math.acos(Math.max(-1, Math.min(1, (v1x * v2x + v1y * v2y) / (Math.sqrt(v1x * v1x + v1y * v1y) * Math.sqrt(v2x * v2x + v2y * v2y) + 0.001)))) * 57.2958;
        };

        const getAngles = (lm) => lm?.length >= 29 ? {
            left_elbow: calcAngle(lm[11], lm[13], lm[15]), 
            right_elbow: calcAngle(lm[12], lm[14], lm[16]),
            left_knee: calcAngle(lm[23], lm[25], lm[27]), 
            right_knee: calcAngle(lm[24], lm[26], lm[28]),
            left_arm_raise: calcAngle(lm[23], lm[11], lm[13]), 
            right_arm_raise: calcAngle(lm[24], lm[12], lm[14])
        } : null;

        // Check if angle is in phase range
        const isInPhase = (angles, phaseAngles) => {
            let matches = 0, total = 0;
            for (const [name, [min, max]] of Object.entries(phaseAngles)) {
                if (angles[name] !== undefined) {
                    total++;
                    if (angles[name] >= min && angles[name] <= max) matches++;
                }
            }
            return total > 0 && (matches / total) >= 0.7; // 70% of angles must match
        };

        const evaluateForm = (angles, ex, currentPhase, landmarks) => {
            const phases = ex.phases;
            const phaseNames = Object.keys(phases);
            let bestPh = 'TRANSITION', bestScore = 0;
            const fb = [];

            for (const [ph, phAngles] of Object.entries(phases)) {
                let score = 0, total = 0;
                for (const [name, [min, max]] of Object.entries(phAngles)) {
                    if (angles[name] !== undefined) {
                        total++; 
                        const v = angles[name];
                        if (v >= min && v <= max) {
                            score += 100;
                        } else { 
                            const diff = v < min ? min - v : v - max; 
                            score += Math.max(0, 100 - diff * 2.5); 
                            if (diff > 20) {
                                fb.push(`${name.replace(/_/g, ' ')}: ${v < min ? 'extend' : 'bend'} more`);
                            }
                        }
                    }
                }
                if (total > 0 && score / total > bestScore) { 
                    bestScore = score / total; 
                    bestPh = ph; 
                }
            }
            
            // Additional shoulder press specific checks (from combined.py)
            if (ex.id === 'shoulder_press' && landmarks) {
                // Symmetry check - both arms should move evenly
                if (Math.abs(angles.left_elbow - angles.right_elbow) > 20) {
                    fb.unshift("Keep arms moving evenly");
                }
                
                // Elbow-over-wrist check (wrist should be aligned under elbow)
                const lw_x = landmarks[15].x; // left wrist
                const le_x = landmarks[13].x; // left elbow
                const rw_x = landmarks[16].x; // right wrist
                const re_x = landmarks[14].x; // right elbow
                
                if (Math.abs(le_x - lw_x) > 0.05 || Math.abs(re_x - rw_x) > 0.05) {
                    fb.unshift("Stack wrists over elbows");
                }
            }
            
            return { accuracy: bestScore, phase: bestPh, feedback: [...new Set(fb)].slice(0, 2) };
        };

        const CONNS = [[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[25,27],[24,26],[26,28]];
        
        const drawSkeleton = (ctx, lm, w, h, color) => {
            ctx.strokeStyle = color; ctx.lineWidth = 3;
            CONNS.forEach(([a, b]) => { 
                ctx.beginPath(); 
                ctx.moveTo(lm[a].x * w, lm[a].y * h); 
                ctx.lineTo(lm[b].x * w, lm[b].y * h); 
                ctx.stroke(); 
            });
            ctx.fillStyle = color; 
            for (let i = 11; i < 29; i++) { 
                ctx.beginPath(); 
                ctx.arc(lm[i].x * w, lm[i].y * h, 5, 0, 6.28); 
                ctx.fill(); 
            }
        };

        // ==================== EXERCISES ====================
        const EXERCISES = [
            { 
                id: "shoulder_press", 
                name: "Shoulder Press", 
                category: "Shoulders", 
                gif: "https://media1.tenor.com/m/vFJSvh8AvhAAAAAC/a1.gif", 
                muscles: ["Deltoids", "Triceps"], 
                description: "Press weights overhead", 
                phases: { 
                    DOWN: { left_elbow: [60, 110], right_elbow: [60, 110] }, 
                    UP: { left_elbow: [155, 180], right_elbow: [155, 180] } 
                }, 
                trackAngle: 'left_elbow',
                movementThreshold: 25,
                tips: ["Feet shoulder-width", "Weights at shoulders", "Press straight up", "Lower with control"] 
            },
            { 
                id: "squat", 
                name: "Squat", 
                category: "Legs", 
                gif: "https://media1.tenor.com/m/Pfj8vy41k-0AAAAC/gym.gif", 
                muscles: ["Quads", "Glutes"], 
                description: "Lower body strength", 
                phases: { 
                    STANDING: { left_knee: [160, 180], right_knee: [160, 180] }, 
                    BOTTOM: { left_knee: [70, 110], right_knee: [70, 110] } 
                }, 
                trackAngle: 'left_knee',
                movementThreshold: 30,
                tips: ["Feet shoulder-width", "Chest up", "Thighs parallel", "Drive through heels"] 
            },
            { 
                id: "pushup", 
                name: "Push Up", 
                category: "Chest", 
                gif: "https://media1.tenor.com/m/EEJO0ylQ8tAAAAAC/flexiones-basicas.gif", 
                muscles: ["Chest", "Triceps"], 
                description: "Upper body classic", 
                phases: { 
                    UP: { left_elbow: [160, 180], right_elbow: [160, 180] }, 
                    DOWN: { left_elbow: [70, 110], right_elbow: [70, 110] } 
                }, 
                trackAngle: 'left_elbow',
                movementThreshold: 30,
                tips: ["Hands wide", "Body straight", "Chest to ground", "Push up fully"] 
            },
            { 
                id: "lunge", 
                name: "Lunge", 
                category: "Legs", 
                gif: "https://media1.tenor.com/m/sZ7VwZ6jrbcAAAAC/gym.gif", 
                muscles: ["Quads", "Glutes"], 
                description: "Unilateral leg strength", 
                phases: { 
                    STANDING: { left_knee: [150, 180], right_knee: [150, 180] }, 
                    DOWN: { left_knee: [80, 120], right_knee: [80, 120] } 
                }, 
                trackAngle: 'left_knee',
                movementThreshold: 30,
                tips: ["Step forward", "Both knees 90¬∞", "Front knee over ankle", "Push back"] 
            },
            { 
                id: "lateral_raise", 
                name: "Lateral Raise", 
                category: "Shoulders", 
                gif: "https://media1.tenor.com/m/-OavRqpxSaEAAAAC/eleva√ß√£o-lateral.gif", 
                muscles: ["Side Delts"], 
                description: "Wider shoulders", 
                phases: { 
                    DOWN: { left_arm_raise: [0, 40], right_arm_raise: [0, 40] }, 
                    UP: { left_arm_raise: [70, 110], right_arm_raise: [70, 110] } 
                },
                trackAngle: 'left_arm_raise',
                movementThreshold: 30,
                tips: ["Dumbbells at sides", "Slight elbow bend", "Raise to shoulder height", "Control"] 
            }
        ];
        const CATEGORIES = ['All', 'Shoulders', 'Chest', 'Arms', 'Legs'];

        // ==================== COMPONENTS ====================
        const Header = ({ totalReps }) => (
            <header className="header">
                <div className="logo">üí™ Form<span>Fit</span> AI</div>
                <div className="header-right">
                    <div className="stat">
                        <div className="stat-value">{totalReps}</div>
                        <div className="stat-label">Total Reps</div>
                    </div>
                </div>
            </header>
        );

        const VoiceBanner = ({ voiceOn, setVoiceOn, speaking }) => (
            <div className="voice-banner">
                <div className={`voice-avatar ${speaking ? 'speaking' : ''}`}>ü§ñ</div>
                <div className="voice-info">
                    <div className="voice-title">AI Voice Coach</div>
                    <div className="voice-status">{voiceOn ? "Ready to guide" : "Voice off"}</div>
                </div>
                <button className={`btn ${voiceOn ? 'btn-purple' : 'btn-secondary'}`} onClick={() => setVoiceOn(!voiceOn)}>
                    {voiceOn ? 'üîä On' : 'üîá Off'}
                </button>
            </div>
        );

        const CategoryTabs = ({ categories, active, onChange }) => (
            <div className="tabs">
                {categories.map(c => (
                    <button key={c} className={`tab ${active === c ? 'active' : ''}`} onClick={() => onChange(c)}>{c}</button>
                ))}
            </div>
        );

        const ExerciseCard = ({ exercise, onClick }) => (
            <div className="card" onClick={onClick}>
                <div className="card-img"><img src={exercise.gif} alt={exercise.name} loading="lazy" /></div>
                <div className="card-body">
                    <div className="card-category">{exercise.category}</div>
                    <div className="card-title">{exercise.name}</div>
                    <div className="card-desc">{exercise.description}</div>
                    <div className="card-muscles">{exercise.muscles.map(m => <span key={m} className="muscle-tag">{m}</span>)}</div>
                </div>
            </div>
        );

        const ExerciseGrid = ({ exercises, onSelect }) => (
            <div className="grid">
                {exercises.map(e => <ExerciseCard key={e.id} exercise={e} onClick={() => onSelect(e)} />)}
            </div>
        );

        const VideoOverlay = ({ fps, accuracy, phase, reps, speaking, coachMsg, isMoving, repState }) => (
            <div className="overlay">
                <div className="fps-counter">{fps} FPS</div>
                <div className="stat-box accuracy-box">
                    <div className="label">{isMoving ? 'Accuracy' : 'Status'}</div>
                    <div className={`value ${isMoving ? (accuracy > 70 ? 'good' : accuracy > 40 ? 'ok' : 'bad') : 'bad'}`}>
                        {isMoving ? `${accuracy}%` : 'Idle'}
                    </div>
                </div>
                <div className="stat-box phase-box">
                    <div className="label">Phase</div>
                    <div className={`value ${!isMoving ? 'idle' : ''}`}>{isMoving ? phase : 'WAITING'}</div>
                </div>
                <div className="stat-box rep-box">
                    <div className="label">Reps</div>
                    <div className="value">{reps}</div>
                </div>
                <div className={`coach-box ${speaking ? 'speaking' : ''}`}>
                    <div className="coach-avatar-sm">ü§ñ</div>
                    <div className="coach-msg">{coachMsg || (isMoving ? "Keep going!" : "Start the exercise!")}</div>
                </div>
            </div>
        );

        const ExercisePreview = ({ exercise }) => (
            <div className="panel-card">
                <img src={exercise.gif} alt={exercise.name} className="preview-img" />
                <div className="preview-name">{exercise.name}</div>
                <div className="preview-cat">{exercise.category}</div>
            </div>
        );

        const VoiceSettings = ({ voiceOn, setVoiceOn }) => (
            <div className="panel-card">
                <div className="panel-title">üé§ Voice Coach</div>
                <div className="toggle-row">
                    <span>Voice Feedback</span>
                    <div className={`toggle ${voiceOn ? 'on' : ''}`} onClick={() => setVoiceOn(!voiceOn)} />
                </div>
            </div>
        );

        const FeedbackPanel = ({ feedback, isMoving }) => (
            <div className="panel-card">
                <div className="panel-title">Feedback</div>
                {!isMoving ? (
                    <div className="feedback-item warning">‚è≥ Start exercising to get feedback</div>
                ) : feedback.length === 0 ? (
                    <div className="feedback-item good">‚úì Great form!</div>
                ) : (
                    feedback.map((f, i) => <div key={i} className="feedback-item bad">! {f}</div>)
                )}
            </div>
        );

        const InstructionsPanel = ({ tips }) => (
            <div className="panel-card">
                <div className="panel-title">Tips</div>
                {tips.map((t, i) => (
                    <div key={i} className="instruction">
                        <div className="instruction-num">{i + 1}</div>
                        <div className="instruction-text">{t}</div>
                    </div>
                ))}
            </div>
        );

        const Loading = ({ message }) => (
            <div className="loading">
                <div className="loading-icon"></div>
                <div>{message}</div>
            </div>
        );

        // ==================== VIEWS ====================
        const BrowseView = ({ category, setCategory, onSelect, voiceOn, setVoiceOn, speaking }) => {
            const exercises = category === 'All' ? EXERCISES : EXERCISES.filter(e => e.category === category);
            return (
                <>
                    <VoiceBanner voiceOn={voiceOn} setVoiceOn={setVoiceOn} speaking={speaking} />
                    <div className="page-title">
                        <h1>Choose Exercise</h1>
                        <p>AI form analysis with voice coaching</p>
                    </div>
                    <CategoryTabs categories={CATEGORIES} active={category} onChange={setCategory} />
                    <ExerciseGrid exercises={exercises} onSelect={onSelect} />
                </>
            );
        };

        const AnalyzeView = ({ exercise, onBack, onRep, voiceOn, setVoiceOn, speaking, coachMsg }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const poseRef = useRef(null);
            
            // Movement tracking
            const angleHistory = useRef([]);
            const lastPhaseRef = useRef(null);
            const repStateRef = useRef('IDLE');
            const lastFB = useRef(0);
            const frameCount = useRef(0);
            const lastFpsTime = useRef(Date.now());
            const processing = useRef(false);
            
            const [ready, setReady] = useState(false);
            const [accuracy, setAccuracy] = useState(0);
            const [phase, setPhase] = useState('READY');
            const [reps, setReps] = useState(0);
            const [feedback, setFeedback] = useState([]);
            const [fps, setFps] = useState(0);
            const [isMoving, setIsMoving] = useState(false);
            const [repState, setRepState] = useState('IDLE');

            const onResults = useCallback((results) => {
                const canvas = canvasRef.current;
                const ctx = canvas?.getContext('2d');
                if (!ctx) return;

                // FPS
                frameCount.current++;
                const now = Date.now();
                if (now - lastFpsTime.current >= 1000) { 
                    setFps(frameCount.current); 
                    frameCount.current = 0; 
                    lastFpsTime.current = now; 
                }

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (results.poseLandmarks) {
                    const lm = results.poseLandmarks;
                    const angles = getAngles(lm);
                    
                    if (angles) {
                        // Track angle history for movement detection
                        const trackAngle = exercise.trackAngle || 'left_elbow';
                        angleHistory.current.push(angles[trackAngle]);
                        if (angleHistory.current.length > 15) angleHistory.current.shift();
                        
                        // Detect movement - check if angle changed significantly
                        let moving = false;
                        if (angleHistory.current.length >= 10) {
                            const recent = angleHistory.current.slice(-10);
                            const min = Math.min(...recent);
                            const max = Math.max(...recent);
                            const range = max - min;
                            moving = range > (exercise.movementThreshold || 25);
                        }
                        setIsMoving(moving);

                        // Evaluate form (pass landmarks for shoulder press checks)
                        const { accuracy: acc, phase: ph, feedback: fb } = evaluateForm(angles, exercise, phase, lm);
                        
                        // Debug logging
                        if (fb.length > 0) {
                            console.log('Form errors detected:', fb);
                        }
                        
                        // Only show accuracy when moving
                        if (moving) {
                            setAccuracy(Math.round(acc));
                            setFeedback(fb);
                        } else {
                            setAccuracy(0);
                            setFeedback([]);
                        }
                        setPhase(ph);

                        // REP COUNTING STATE MACHINE
                        const phaseNames = Object.keys(exercise.phases);
                        const phase1 = phaseNames[0];
                        const phase2 = phaseNames[1];

                        // Check if truly in phase (not just close)
                        const inPhase1 = isInPhase(angles, exercise.phases[phase1]);
                        const inPhase2 = isInPhase(angles, exercise.phases[phase2]);

                        // State machine for rep counting
                        if (moving) {
                            const currentState = repStateRef.current;
                            
                            if (currentState === 'IDLE' && inPhase1) {
                                repStateRef.current = 'PHASE1';
                                setRepState('PHASE1');
                            } 
                            else if (currentState === 'PHASE1' && inPhase2) {
                                repStateRef.current = 'PHASE2';
                                setRepState('PHASE2');
                            }
                            else if (currentState === 'PHASE2' && inPhase1) {
                                // Completed a full rep!
                                setReps(r => {
                                    const newReps = r + 1;
                                    voiceCoach.announceRep(newReps);
                                    onRep();
                                    return newReps;
                                });
                                repStateRef.current = 'PHASE1';
                                setRepState('PHASE1');
                            }
                        }

                        // Voice feedback - prioritize form corrections
                        const hasErrors = fb.length > 0;
                        const minDelay = hasErrors ? 3000 : 6000; // Faster feedback for errors
                        
                        if (now - lastFB.current > minDelay) {
                            const msg = voiceCoach.getFeedback(acc, fb, moving, repStateRef.current !== 'IDLE');
                            if (msg) {
                                voiceCoach.speak(msg);
                                lastFB.current = now;
                            }
                        }

                        // Draw skeleton
                        const color = !moving ? '#888888' : (acc > 70 ? '#00ff87' : acc > 40 ? '#00d4ff' : '#ff3860');
                        drawSkeleton(ctx, lm, canvas.width, canvas.height, color);
                    }
                }
            }, [exercise, onRep, phase]);

            useEffect(() => {
                const init = async () => {
                    const pose = new Pose({ 
                        locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${f}` 
                    });
                    pose.setOptions({ 
                        modelComplexity: 0, 
                        smoothLandmarks: true, 
                        minDetectionConfidence: 0.5, 
                        minTrackingConfidence: 0.5 
                    });
                    pose.onResults(onResults);
                    poseRef.current = pose;

                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ 
                            video: { width: 640, height: 480, facingMode: 'user' } 
                        });
                        videoRef.current.srcObject = stream;
                        await videoRef.current.play();
                        canvasRef.current.width = videoRef.current.videoWidth;
                        canvasRef.current.height = videoRef.current.videoHeight;
                        setReady(true);
                        voiceCoach.start(exercise.name);

                        let skip = 0;
                        const process = async () => {
                            if (!poseRef.current) return;
                            skip++; 
                            if (skip % 2 === 0 && !processing.current) { 
                                processing.current = true; 
                                await poseRef.current.send({ image: videoRef.current }); 
                                processing.current = false; 
                            }
                            requestAnimationFrame(process);
                        };
                        process();
                    } catch (e) { 
                        alert("Camera access denied"); 
                    }
                };
                init();

                return () => { 
                    videoRef.current?.srcObject?.getTracks().forEach(t => t.stop()); 
                    poseRef.current?.close(); 
                    voiceCoach.stop(); 
                };
            }, []);

            const stop = () => { 
                voiceCoach.end(exercise.name, reps); 
                onBack(); 
            };

            return (
                <>
                    <div className="back-btn" onClick={stop}>‚Üê Back</div>
                    <div className="analysis">
                        <div className="video-box">
                            <video ref={videoRef} playsInline style={{ transform: 'scaleX(-1)' }} />
                            <canvas ref={canvasRef} style={{ transform: 'scaleX(-1)' }} />
                            {ready ? (
                                <VideoOverlay 
                                    fps={fps} 
                                    accuracy={accuracy} 
                                    phase={phase} 
                                    reps={reps} 
                                    speaking={speaking} 
                                    coachMsg={coachMsg}
                                    isMoving={isMoving}
                                    repState={repState}
                                />
                            ) : (
                                <Loading message="Loading camera..." />
                            )}
                        </div>
                        <div className="panel">
                            <ExercisePreview exercise={exercise} />
                            <VoiceSettings voiceOn={voiceOn} setVoiceOn={setVoiceOn} />
                            <FeedbackPanel feedback={feedback} isMoving={isMoving} />
                            <InstructionsPanel tips={exercise.tips} />
                            <button className="btn btn-danger btn-full" onClick={stop}>End Workout</button>
                        </div>
                    </div>
                </>
            );
        };

        // ==================== APP ====================
        const App = () => {
            const [view, setView] = useState('browse');
            const [exercise, setExercise] = useState(null);
            const [category, setCategory] = useState('All');
            const [totalReps, setTotalReps] = useState(0);
            const [voiceOn, setVoiceOn] = useState(true);
            const [speaking, setSpeaking] = useState(false);
            const [coachMsg, setCoachMsg] = useState("");

            useEffect(() => { 
                voiceCoach.onChange = (s, m) => { setSpeaking(s); setCoachMsg(m); }; 
            }, []);
            
            useEffect(() => { 
                voiceCoach.setEnabled(voiceOn); 
            }, [voiceOn]);

            return (
                <div className="app">
                    <Header totalReps={totalReps} />
                    <main className="main">
                        {view === 'browse' ? (
                            <BrowseView 
                                category={category} 
                                setCategory={setCategory} 
                                onSelect={e => { setExercise(e); setView('analyze'); }} 
                                voiceOn={voiceOn} 
                                setVoiceOn={setVoiceOn} 
                                speaking={speaking} 
                            />
                        ) : (
                            <AnalyzeView 
                                exercise={exercise} 
                                onBack={() => setView('browse')} 
                                onRep={() => setTotalReps(t => t + 1)} 
                                voiceOn={voiceOn} 
                                setVoiceOn={setVoiceOn} 
                                speaking={speaking} 
                                coachMsg={coachMsg} 
                            />
                        )}
                    </main>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>